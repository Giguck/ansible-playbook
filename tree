---
- name: Создание файлового дерева и загрузка на сервер
  hosts: all
  vars:
    target_directory: /home
    output_filename: "file_tree_{{ ansible_hostname }}_{{ ansible_date_time.epoch }}.txt"
    local_download_path: "./downloads/"
  
  tasks:
    - name: Создание временной директории
      file:
        path: /tmp/ansible_file_tree
        state: directory
        mode: '0755'
      become: yes

    - name: Генерация файлового дерева
      shell: |
        find "{{ target_directory }}" -type f -printf "%T+ %p %k KB\n" | sort > "/tmp/ansible_file_tree/{{ output_filename }}"
      args:
        executable: /bin/bash
      register: tree_result
      failed_when: tree_result.rc != 0 and tree_result.rc != 1
      become: yes

    - name: Проверка создания файла
      stat:
        path: "/tmp/ansible_file_tree/{{ output_filename }}"
      register: file_stat

    - name: Создание локальной директории для загрузки
      delegate_to: localhost
      run_once: yes
      file:
        path: "{{ local_download_path }}"
        state: directory
        mode: '0755'

    - name: Загрузка файла на управляющую машину
      fetch:
        src: "/tmp/ansible_file_tree/{{ output_filename }}"
        dest: "{{ local_download_path }}"
        flat: yes

    - name: Очистка временных файлов
      file:
        path: /tmp/ansible_file_tree
        state: absent
      become: yes
      ignore_errors: yes
